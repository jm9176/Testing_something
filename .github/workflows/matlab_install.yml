name: Test with LocalStack

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      localstack:
        image: localstack/localstack
        ports:
          - 4566:4566  # LocalStack's edge port for all services
        options: >-
          --name localstack
          -e SERVICES=s3
          -e DEFAULT_REGION=us-east-1
          -v "${{github.workspace}}/test/testfiles:/data"

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        path: my-repo

    - name: Install AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install

    - name: Configure AWS CLI
      run: |
        aws configure set aws_access_key_id test
        aws configure set aws_secret_access_key test
        aws configure set default.region us-east-1
        aws configure set default.s3.endpoint_url http://localhost:4566

    - name: Create S3 bucket
      run: |
        aws s3api create-bucket --bucket my-bucket --endpoint-url=http://localhost:4566

    - name: Copy file to S3
      run: |
        aws s3 cp /data/sample_file.nc s3://my-bucket/sample_file.nc --endpoint-url=http://localhost:4566

    - name: Verify S3 bucket creation
      run: |
        aws s3 ls --endpoint-url=http://localhost:4566